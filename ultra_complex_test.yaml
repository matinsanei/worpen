name: Ultra Complex YAML Test - Fixed
description: Sequential complex operations with proper variable scoping
path: /api/test/ultra-complex
method: POST
parameters:
  - name: user_data
    param_type: body
    data_type: object
    required: true
  - name: threshold
    param_type: body
    data_type: number
    required: false
logic:
  # Step 1: Calculate total
  - !MathOp
    operation: sum
    args: [85, 92, 78, 95, 88]
  
  - !Set
    var: total_score
    value: "{{math_result}}"
  
  # Step 2: Calculate average
  - !MathOp
    operation: divide
    args: ["{{total_score}}", 5]
  
  - !Set
    var: average
    value: "{{math_result}}"
  
  # Step 3: Determine grade based on average
  - !Set
    var: grade
    value: C
  
  - !Set
    var: status
    value: Average
  
  - !Set
    var: multiplier
    value: 1.0
  
  # Check for grade A
  - !If
    condition: "{{average}} >= 90"
    then:
      - !Set
        var: grade
        value: A
      - !Set
        var: status
        value: Excellent
      - !Set
        var: multiplier
        value: 1.1
    else: []
  
  # Check for grade B (only if not A)
  - !If
    condition: '{{grade}} == C'
    then:
      - !If
        condition: "{{average}} >= 80"
        then:
          - !Set
            var: grade
            value: B
          - !Set
            var: status
            value: Good
          - !Set
            var: multiplier
            value: 1.05
        else: []
    else: []
  
  # Step 4: Calculate bonus
  - !MathOp
    operation: multiply
    args: ["{{average}}", "{{multiplier}}"]
  
  - !Set
    var: bonus_score
    value: "{{math_result}}"
  
  # Step 5: Round final score
  - !MathOp
    operation: round
    args: ["{{bonus_score}}"]
  
  - !Set
    var: final_score
    value: "{{math_result}}"
  
  # Step 6: String operations
  - !StringOp
    operation: upper
    input: "{{status}}"
    args: []
  
  - !Set
    var: status_text
    value: "{{string_result}}"
  
  # Step 7: Check bonus eligibility
  - !Set
    var: has_bonus
    value: false
  
  - !Set
    var: bonus_amount
    value: 0
  
  - !If
    condition: "{{final_score}} > 95"
    then:
      - !Set
        var: has_bonus
        value: true
      - !MathOp
        operation: subtract
        args: ["{{final_score}}", 95]
      - !Set
        var: bonus_amount
        value: "{{math_result}}"
    else: []
  
  # Step 8: Determine reward
  - !Set
    var: reward
    value: No Reward
  
  - !Set
    var: level
    value: basic
  
  - !If
    condition: "{{has_bonus}}"
    then:
      - !Set
        var: reward
        value: Silver Medal
      - !Set
        var: level
        value: standard
    else: []
  
  - !If
    condition: "{{has_bonus}}"
    then:
      - !If
        condition: "{{bonus_amount}} > 5"
        then:
          - !Set
            var: reward
            value: Gold Medal
          - !Set
            var: level
            value: premium
        else: []
    else: []
  
  # Step 9: Create message text
  - !Set
    var: message_text
    value: "Student achieved grade {{grade}} with {{status_text}} performance"
  
  # Step 10: Set total_operations
  - !Set
    var: total_operations
    value: 30
  
  # Step 11: Return all data
  - !Return
    value:
      grade: "{{grade}}"
      status: "{{status_text}}"
      average: "{{average}}"
      total: "{{total_score}}"
      multiplier: "{{multiplier}}"
      bonus_score: "{{bonus_score}}"
      final_score: "{{final_score}}"
      has_bonus: "{{has_bonus}}"
      bonus_amount: "{{bonus_amount}}"
      reward: "{{reward}}"
      level: "{{level}}"
      message: "{{message_text}}"
      calculations: "{{total_operations}}"

enabled: true
version: 1.0.0
