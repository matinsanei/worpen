name: Medium Complexity Test
description: Test with loops, DB, conditions
path: /api/test/medium
method: POST
enabled: true
version: 1.0.0

parameters:
  - name: user_id
    param_type: body
    data_type: number
    required: true
  - name: items
    param_type: body
    data_type: array
    required: true

logic:
  # Initialize
  - set:
      var: total
      value: 0
  
  # Get user from DB
  - query_db:
      query: SELECT * FROM agents WHERE id = $1 LIMIT 1
      params:
        - "{{body.user_id}}"
  
  - set:
      var: user_exists
      value: true
  
  # Calculate total using loop
  - loop:
      collection: "{{body.items}}"
      var: item
      body:
        - set:
            var: item_total
            value: "{{item.price * item.qty}}"
        
        - set:
            var: total
            value: "{{total + item_total}}"
  
  # Check and return
  - if:
      condition: total > 1000
      then:
        - return:
            value:
              success: true
              total: "{{total}}"
              discount: 10
              final: "{{total * 0.9}}"
      otherwise:
        - return:
            value:
              success: true
              total: "{{total}}"
              discount: 0
              final: "{{total}}"
